# 📨 NodeLabs Real‑Time Chat Repo

A full‑stack playground that shows how to build a **Real‑time messenger** with modern Node tooling:

| Layer    | Tech                                                                          |
| -------- | ----------------------------------------------------------------------------- |
| API      | **Express 5** · **TypeScript** · **Pino** logger                              |
| DB       | **MongoDB 7** with Mongoose                                                   |
| Realtime | **Socket.IO 4**                                                               |
| Queue    | **RabbitMQ 3** (Classic)                                                      |
| Cache    | **Redis 7** (online users · refresh‑token blacklist · message cache)          |
| Search   | **Elasticsearch 8** (message full‑text search)                                |
| Jobs     | **node‑cron** + worker container                                              |
| Auth     | **JWT (HS256)**                                                               |
| Docs     | **Swagger 3.1 / OpenAPI** – served at `/docs`                                 |
| Infra    | Docker + Compose v2                                                           |

---

## 📦 1 · Clone & Boot

```bash
# 0. clone
$ git clone https://github.com/<you>/nodelabs-case.git && cd nodelabs-case

# 1. generate an INTERNAL_TOKEN so the worker can call the API
chmod +x generate-token.sh
$ ./generate-token.sh

# 2. build images & start containers (API + worker only)
$ docker compose up --build 

$ docker compose exec api npm run seed -- --fresh
```

The first boot can take \~1 minute – Elasticsearch has to warm‑up, then the API creates the `messages` index.

Once logs show `API up @3000` you are ready.\
Default creds: *RabbitMQ UI* ➜ [http://localhost:15672](http://localhost:15672)   **guest / guest**

---

## 🔌 2 · Explore the API (Swagger)

Open [http://localhost:3000/docs](http://localhost:3000/docs) – generated at runtime from `src/docs/swagger.ts`.



---

## 🧪 3 · Smoke‑test the happy path

`smoketest.sh` registers a user, logs‑in, refreshes the access‑token, spins‑up a second user, creates a conversation and exchanges a message.

chmod +x generate-token.sh

```bash
chmod +x smoketest.sh
$ ./smoketest.sh

✔ register … ok
✔ login … ok
✔ refresh … ok
✔ create conversation … ok
✔ send message … ok
✔ search message (ES) … ok
```

### `tools/smoketest.sh`

Make it executable: `chmod +x tools/smoketest.sh`.

---

## 📚 4 · Project layout (TL;DR)

```
api/
  src/
    controllers/   – REST handlers
    sockets/        – Socket.IO gateway
    jobs/           – cron 02:00 auto‑message planner
    utils/          – rabbit | redis | elastic | jwt | logger
    docs/swagger.ts – OpenAPI spec
  Dockerfile        – builds /dist
worker/
  src/consumer.ts   – RabbitMQ consumer + Socket.IO client
  Dockerfile
scripts/
  generateInternalToken.ts   – used by generate-token.sh
  reindexMessages.ts         – (re)index existing docs into Elasticsearch
```

---

## 🐳 5 · Environment variables

| var              | default                            | who uses it  |
| ---------------- | ---------------------------------- | ------------ |
| `MONGO`          | `mongodb://mongo:27017/chat`       | API · worker |
| `REDIS`          | `redis://redis:6379`               | API          |
| `RABBITMQ_URL`   | `amqp://rabbitmq:5672`             | API · worker |
| `ELASTIC_URL`    | `http://elastic:9200`              | API          |
| `JWT_SECRET`     | `changeme`                         | API · worker |
| `INTERNAL_TOKEN` | generated by **generate-token.sh** | worker       |

---

## 🧹 6 · Lint, rebuild

```bash
npm --prefix api run lint            
./generate-token.sh           
docker compose up --build      
```

---

## 📄 License

MIT – use for learning & experiments.

