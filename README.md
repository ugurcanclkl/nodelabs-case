# ğŸ“¨ NodeLabs Realâ€‘Time Chat Repo

A fullâ€‘stack playground that shows how to build a **Realâ€‘time messenger** with modern Node tooling:

| Layer    | Tech                                                                          |
| -------- | ----------------------------------------------------------------------------- |
| API      | **ExpressÂ 5** Â· **TypeScript** Â· **Pino** logger                              |
| DB       | **MongoDBÂ 7** with Mongoose                                                   |
| Realtime | **Socket.IOÂ 4**                                                               |
| Queue    | **RabbitMQÂ 3** (Classic)                                                      |
| Cache    | **RedisÂ 7** (online users Â· refreshâ€‘token blacklist Â· message cache)          |
| Search   | **ElasticsearchÂ 8** (message fullâ€‘text search)                                |
| Jobs     | **nodeâ€‘cron** + worker container                                              |
| Auth     | **JWTÂ (HS256)**                                                               |
| Docs     | **SwaggerÂ 3.1 / OpenAPI** â€“ served at `/docs`                                 |
| Infra    | DockerÂ +Â Compose v2                                                           |

---

## ğŸ“¦ 1Â Â·Â Clone & Boot

```bash
# 0. clone
$ git clone https://github.com/<you>/nodelabs-case.git && cd nodelabs-case

# 1. generate an INTERNAL_TOKEN so the worker can call the API
chmod +x generate-token.sh
$ ./generate-token.sh

# 2. build images & start containers (API + worker only)
$ docker compose up --build 

$ docker compose exec api npm run seed -- --fresh
```

The first boot can take \~1Â minute â€“ Elasticsearch has to warmâ€‘up, then the API creates the `messages` index.

Once logs show `API up @3000` you are ready.\
Default creds: *RabbitMQ UI* âœ [http://localhost:15672](http://localhost:15672) Â  **guest / guest**

---

## ğŸ”Œ 2Â Â·Â Explore the API (Swagger)

Open [http://localhost:3000/docs](http://localhost:3000/docs) â€“ generated at runtime fromÂ `src/docs/swagger.ts`.



---

## ğŸ§ª 3Â Â·Â Smokeâ€‘test the happy path

`smoketest.sh` registers a user, logsâ€‘in, refreshes the accessâ€‘token, spinsâ€‘up a second user, creates a conversation and exchanges a message.

chmod +x generate-token.sh

```bash
chmod +x smoketest.sh
$ ./smoketest.sh

âœ” register â€¦ ok
âœ” login â€¦ ok
âœ” refresh â€¦ ok
âœ” create conversation â€¦ ok
âœ” send message â€¦ ok
âœ” search message (ES) â€¦ ok
```

### `tools/smoketest.sh`

Make it executable: `chmod +x tools/smoketest.sh`.

---

## ğŸ“š 4Â Â·Â Project layout (TL;DR)

```
api/
  src/
    controllers/   â€“ REST handlers
    sockets/        â€“ Socket.IO gateway
    jobs/           â€“ cron 02:00 autoâ€‘message planner
    utils/          â€“ rabbit | redis | elastic | jwt | logger
    docs/swagger.ts â€“ OpenAPI spec
  Dockerfile        â€“ builds /dist
worker/
  src/consumer.ts   â€“ RabbitMQ consumer + Socket.IO client
  Dockerfile
scripts/
  generateInternalToken.ts   â€“ used by generate-token.sh
  reindexMessages.ts         â€“ (re)index existing docs into Elasticsearch
```

---

## ğŸ³ 5Â Â·Â Environment variables

| var              | default                            | who uses it  |
| ---------------- | ---------------------------------- | ------------ |
| `MONGO`          | `mongodb://mongo:27017/chat`       | API Â· worker |
| `REDIS`          | `redis://redis:6379`               | API          |
| `RABBITMQ_URL`   | `amqp://rabbitmq:5672`             | API Â· worker |
| `ELASTIC_URL`    | `http://elastic:9200`              | API          |
| `JWT_SECRET`     | `changeme`                         | API Â· worker |
| `INTERNAL_TOKEN` | generated by **generate-token.sh** | worker       |

---

## ğŸ§¹ 6Â Â·Â Lint, rebuild

```bash
npm --prefix api run lint            
./generate-token.sh           
docker compose up --build      
```

---

## ğŸ“„ License

MIT â€“ use for learning & experiments.

